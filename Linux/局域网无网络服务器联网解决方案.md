

# 局域网无网络服务器联网解决方案

## 1. X11转发ubuntu服务器火狐浏览器

这是我之前一直在用的方案，`x11`转发也比较好实现，缺点主要有：

1. 界面很卡，浏览器登录校园网很费劲
2. 配置麻烦，需要一个`xming`或者`xQuartz`插件
3. 对于校园网（我们校园网一个账号只能登陆两台设备）来说，这样就需要占用一个账号了。

## 2. 通过本机代理服务器网络

我们的笔记本电脑如果是与服务器在一个局域网的话，是可以通过将我们的笔记本作为代理服务器的，让linux服务器走笔记本的网络，这样不仅不会占用校园网账号，还非常现代化:smile:

### Mac 系统

`SquidMan`是一款`Mac`上的图形化的`squid`代理服务器的安装管理工具。使用`squid`服务器软件可以帮助我们实现如下功能

- 缓存下载内容，减少网络带宽，加速网页浏览。
- 作为代理服务器，供其他设备使用。

这里我们用到的是其代理功能。

下载地址：[SquidMan | Tagline wanted, apply within.](http://squidman.net/squidman/)

#### 1. 查看笔记本的IP地址，同时检验是否能够与局域网内`linux`互相ping通。

1. 对于mac系统可以利用网络设置查看，也可以使用ifconfig查看IP地址：	![image-20211217230055311](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211217230055311.png)

2. 对于`linux`，使用`ifconfig`查看`ip`：
3. 然后在mac 终端ping一下linux的ip，在linux ssh终端ping一下笔记本的ip地址，如果是处于同一个局域网的话，应该是可以ping通的。

#### 2. 打开SquidMan软件，设置端口

![image-20211217230614273](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211217230614273.png)

这里我将端口设置为8089，只要没有占用即可。

在clients中将linux服务器ip写入

![image-20211217230740815](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211217230740815.png)

然后在Template中将这些deny都设置为allow，这里应该不怕什么危险，不用的时候关闭软件即可。

![image-20211217230923102](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211217230923102.png)

设置好之后重启软件即可。

![image-20211217231103436](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211217231103436.png)

#### 3. 设置linux代理

在自己用户下设置bashrc

```bash
vim ~./bashrc
```

在bashrc文件最后添加：

![image-20211217231321465](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211217231321465.png)

然后执行`source ~/.bashrc` ,不出问题，应该就可以联网了

### windows系统

window系统与mac类似，只不过代理软件不同而已。

1. 下载`CCProxy`软件，

![image-20211218152302826](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211218152302826.png)

2. 打开软件，设置查看本机ip

![image-20211218152354165](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211218152354165.png)

3. linux ssh终端ping一下，看是否能够ping通，如果ping不通的话需要关闭windows的防火墙设置：

   ![image-20211218152530913](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211218152530913.png)

5. `ping`通之后，就可以在`linux `设置代理了，这里详细说一下设置代理的三种方式

   > 1. 通过命令`export`临时设置代理变量，此方法只对开着的这个终端起作用，临时用一下可以
   >
   >    export http_proxy="http://10.9.16.20:808" 
   >
   >    export https_proxy="http://10.9.16.20:808"
   >
   >    //取消
   >
   >    unset http_proxy 
   >
   >    unset https_proxy
   >
   > 2. 通过修改用户文件`～/.bashrc`文件，此文件只对你这个用户管用,推荐用这种，设置方式同上面mac的设置方式
   >
   > 3. 修改系统文件，如果你想让这个机器的所有用户都走你这个代理，可以修改系统配置文件，`/etc/profile` 内容就是一样的，写入代理变量
   >
   >    

![image-20211217231321465](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211217231321465.png)

6. 设置完毕后，linux应该就可以通网了，这个时候可以打开CCProxy的监控，看是否走流量：

   ![image-20211218153120635](https://pic-1300286858.cos.ap-nanjing.myqcloud.com/uPic/2021-12/image-20211218153120635.png)

## 3. 通过终端脚本直接连校园网

第三个方法就是想着，能够通过ssh连入服务器之后终端直接模拟浏览器，填入校园网账号密码进行登录。

之所以把这个放在第三，是因为运行这个需要pyhton环境，没有网络的话搭建python环境好麻烦，还需要一些浏览器内核安装，所以可以先通过第二种方法搭建起环境，然后使用第三个方法。

那既然有了第二种方法，为什么还需要第三种方法：

又一个非常重要的应用场景，就是需要服务器一直保持联网状态，比如我们放寒假。这样就可以设定一个定时任务，让服务器自动联网。

### qust联网脚本

这里选择python的selenium库进行这个工作，配合`katalon Recorder`插件，很轻松能够写出这个python脚本。

下面介绍一下它的执行步骤：

在 linux 中的配置和 windows 的配置步骤一样，下面简单介绍一下。

#### 安装 Selenum 库

使用下面的命令安装 selenium 库：

```sh
pip install selenium==3.14.0
```

#### 安装 firefox 浏览器

> firefox 下载地址：[www.firefox.com.cn/download/](https://link.juejin.cn?target=http%3A%2F%2Fwww.firefox.com.cn%2Fdownload%2F)

使用如下命令下载 linux 版本的 firefox 浏览器：

```sh
wget https://download-ssl.firefox.com.cn/releases/firefox/esr/91.0/zh-CN/Firefox-latest-x86_64.tar.bz2
```

下载完成后使用下面的命令解压得到 `Firefox-latest-x86_64.tar`：

```sh
bunzip2 -d Firefox-latest-x86_64.tar.bz2
```

再次使用下面的命令解压：

```sh
tar -xvf Firefox-latest-x86_64.tar
```

#### 安装 firefox 浏览器驱动

> geckodriver 驱动下载地址：[github.com/mozilla/gec…](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmozilla%2Fgeckodriver%2Freleases)

使用下面的命令下载 linux 系统的驱动：

```sh
wget https://github.com/mozilla/geckodriver/releases/download/v0.29.1/geckodriver-v0.29.1-linux64.tar.gz
```

解压 `geckodriver` 

```sh
tar -zxvf geckodriver-v0.29.1-linux64.tar.gz
```

#### Python脚本

```python 
from selenium import webdriver
from subprocess import run

class Qust(object):
    def __init__(self) -> None:
        super().__init__()
        self.firefox_options = webdriver.FirefoxOptions()
        # 使用headless无界面浏览器模式
        self.firefox_options.add_argument('--headless')  # 增加无界面选项
        self.firefox_options.add_argument('--disable-gpu')  # 如果不加这个选项，有时定位会出现问题

        self.executable_path = r"/home/qust-001/Chenjq/qust_login/FireFoxDrive/geckodriver"
        self.firefox_binary=r"/home/qust-001/Chenjq/qust_login/FireFox/firefox/firefox"
    
    def Login(self):
        # 打开firefox浏览器
        driver = webdriver.Firefox(
            executable_path=self.executable_path,
            firefox_binary=self.firefox_binary,
            options=self.firefox_options)

        url = "http://www.qust.edu.cn/"  # 登录网址
        Name = "2019090015"  # 账号a
        Password = "186561"  # 密码

        try:
            # 访问网址
            driver.get(url)
            driver.implicitly_wait(2)  # 隐性等待，最长等20秒
            # 输入账号
            driver.find_element_by_id("username").clear()
            driver.find_element_by_id("username").send_keys(Name)
            driver.find_element_by_xpath("//tr[@id='countTrId']/td").click()
            driver.find_element_by_id("pwd_hk_posi").click()
            driver.find_element_by_id("pwd").clear()
            driver.find_element_by_id("pwd").send_keys(Password)
            driver.find_element_by_xpath("//tr[@id='countTrId']/td").click()
            driver.find_element_by_id("selectDisname").click()
            driver.find_element_by_id("_service_0").click()
            driver.find_element_by_xpath("//a[@id='jizhummNo']/div").click()
            driver.find_element_by_xpath("//a[@id='jizhummYes']/div").click()
            driver.find_element_by_id("loginLink_div").click()
            print("登陆成功")
        except Exception as e:
            print("登陆失败", e)
        finally:
            driver.quit()
    
    def Logout(self):
        # 打开firefox浏览器
        driver = webdriver.Firefox(
                executable_path=self.executable_path,
                firefox_binary=self.firefox_binary,
                options=self.firefox_options)
        try:
            driver.get("http://211.87.158.84/")
            driver.find_element_by_id("toLogOut").click()
            alert = driver.switch_to.alert 
            alert.accept()
            print("退出账号成功")
        except Exception as e:
            print("退出账号失败",e)
        finally:
            driver.quit

if __name__ == "__main__":
    qust = Qust()
    qust.Login()
    qust.Logout()
```

我这里没有做太全的错误排除，我自己测试是没有问题的。

